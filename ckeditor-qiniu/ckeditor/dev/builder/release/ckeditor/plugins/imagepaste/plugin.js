CKEDITOR.plugins.add("imagepaste",{init:function(d){d.addFeature&&d.addFeature({allowedContent:"img[!src,id];"});d.on("paste",function(c){var b=c.data;if(b=b.html||b.type&&"html"==b.type&&b.dataValue)CKEDITOR.env.webkit&&0<b.indexOf("webkit-fake-url")&&(alert("Sorry, the images pasted with Safari aren't usable"),window.open("https://bugs.webkit.org/show_bug.cgi?id\x3d49141"),b=b.replace(/<img src="webkit-fake-url:.*?">/g,"")),b=b.replace(/<img src="data:image\/png;base64,.*?" alt="">/g,function(b){var c=
b.match(/"data:image\/png;base64,(.*?)"/)[1],f=CKEDITOR.tools.getNextId(),a=d.config.filebrowserImageUploadUrl,a=-1==a.indexOf("?")?a+"?":a+"\x26",a=a+("CKEditor\x3d"+d.name+"\x26CKEditorFuncNum\x3d2\x26langCode\x3d"+d.langCode);saveto="qiniu";var a=qiniu_upload_domain,e=new XMLHttpRequest;e.open("POST",a);e.onload=function(){var a=e.responseText.match(/2,\s*'(.*?)',/)[1],b=d.document.getById(f);b.data("cke-saved-src",a);b.setAttribute("src",a);b.removeAttribute("id")};saveto="qiniu";a='-----------------------------1966284435497298061834782736\r\nContent-Disposition: form-data; name\x3d"file"';
c=window.atob(c);a+='; filename\x3d"'+Math.round((new Date).getTime()/1E3)+"_"+f+'.png"\r\nContent-type: image/png';a=a+("\r\n\r\n"+c+"\r\n-----------------------------1966284435497298061834782736")+('\r\nContent-Disposition: form-data; name\x3d"token"\r\n\r\n'+qiniu_uptoken);a+="\r\n\r\n"+c+"\r\n-----------------------------1966284435497298061834782736";a+="--";e.setRequestHeader("Content-Type","multipart/form-data; boundary\x3d---------------------------1966284435497298061834782736");e.sendAsBinary(a);
return b.replace(/>/,' id\x3d"'+f+'"\x3e')}),c.data.html?c.data.html=b:c.data.dataValue=b})}});